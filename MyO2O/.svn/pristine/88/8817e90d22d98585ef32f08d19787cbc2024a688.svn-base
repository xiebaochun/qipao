<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=0, width=device-width"/>
    <title>api</title>
    <link rel="stylesheet" type="text/css" href="../css/common.css" />
    <link rel="stylesheet" type="text/css" href="../css/news.css" />
    <style>
        #main{width:100%;overflow:hidden;background-color: #eee;}
        .my-follow{padding:.5rem .5rem;padding-bottom:.1rem;background-color:#fff}
        .no-follow{text-align:center;padding:1rem 0;color:#999}
        .no-follow>i{vertical-align:middle;font-size:1.2rem;color:#ffd600}
        .no-follow>p{display:inline-block;vertical-align:middle;margin:0;padding-left:.1rem;text-align:left;color:#999}
        .no-follow>p>span{color:#999}
        .possible-like-topic{margin-top:.5rem;padding:.5rem .5rem;padding-bottom:.1rem;background-color:#fff}
        .title{padding:0 .2rem;border-left:2px solid #ffd600;line-height:14px}

        .checkmore{line-height:1.5rem;text-align:center;color:#999}
        .weiguan-bt{border:none;color:#fff;background-color:#ff6362;border-radius:.8rem;font-size:.5rem;line-height:.7rem;padding:4px 10px}

        .animated{-webkit-animation-duration:1s;animation-duration:1s;-webkit-animation-fill-mode:both;animation-fill-mode:both}
        @-webkit-keyframes fadeInLeft{from{opacity:0;-webkit-transform:translate3d(-100%,0,0);transform:translate3d(-100%,0,0)}
        to{opacity:1;-webkit-transform:none;transform:none}
        }
        @keyframes fadeInLeft{from{opacity:0;-webkit-transform:translate3d(-100%,0,0);transform:translate3d(-100%,0,0)}
        to{opacity:1;-webkit-transform:none;transform:none}
        }
        .fadeInLeft{-webkit-animation-name:fadeInLeft;animation-name:fadeInLeft}
        @-webkit-keyframes fadeOutLeft{from{opacity:1}
        to{opacity:0;-webkit-transform:translate3d(-100%,0,0);transform:translate3d(-100%,0,0)}
        }
        @keyframes fadeOutLeft{from{opacity:1}
        to{opacity:0;-webkit-transform:translate3d(-100%,0,0);transform:translate3d(-100%,0,0)}
        }
        .fadeOutLeft{-webkit-animation-name:fadeOutLeft;animation-name:fadeOutLeft}
    </style>
</head>
<body>
    <div id="wrap">
        <div id="main">
            <div class="my-follow">
                <p class="title">我关注的话题</p>
                <div class="follow-body">
                    <div class="no-follow none">
                        <i class="fa fa-plus-circle"></i>
                        <p class="text"><span>暂无关注的任何话题圈...</span><br>
                            <span>点击快速添加</span>
                        </p>
                    </div>
                    <ul class="mui-table-view news-list" id="my-circle-list">
                        
                    </ul>
                    <div class="checkmore checkmore-myfollowed"><span class="checkmore-text color-999">查看更多</span>&nbsp;<i class="fa fa-angle-down"></i></div>
                </div>
            </div>
            <div class="possible-like-topic">
                <p class="title">可能感兴趣的话题圈</p>
                <ul class="mui-table-view news-list" id="circle-list">
                    <!-- <li class="mui-table-view-cell">
                        <a class="mui-navigate">
                            <img src="../image/user/my_message.png" alt="">
                            <div class="topic-circle-info">
                                <span>最爱自拍</span><i class="member-ico fa fa-users"></i><span class="member-count">5423</span><br>
                                <span class="topic-circle-desc">爱自拍不是病，是享受</span>    
                            </div>
                        </a>
                        <span class="follow-bt">关注</span>
                    </li>
                    <li class="mui-table-view-cell">
                        <a class="mui-navigate">
                            <img src="../image/user/my_topic.png" alt="">
                            <div class="topic-circle-info">
                                <span>最爱自拍</span><i class="member-ico fa fa-users"></i><span class="member-count">5423</span><br>
                                <span class="topic-circle-desc">爱自拍不是病，是享受</span>    
                            </div>
                            
                        </a>
                        <span class="follow-bt">关注</span>
                    </li>
                    <li class="mui-table-view-cell">
                        <a class="mui-navigate">
                            <img src="../image/user/my_fav.png" alt="">
                            <div class="topic-circle-info">
                                <span>最爱自拍</span><i class="member-ico fa fa-users"></i><span class="member-count">5423</span><br>
                                <span class="topic-circle-desc">爱自拍不是病，是享受</span>    
                            </div>
                            
                        </a>
                        <span class="follow-bt">关注</span>
                    </li>
                    <li class="mui-table-view-cell">
                        <a class="mui-navigate">
                            <img src="../image/user/my_setting.png" alt="">
                            <div class="topic-circle-info">
                                <span>最爱自拍</span><i class="member-ico fa fa-users"></i><span class="member-count">5423</span><br>
                                <span class="topic-circle-desc">爱自拍不是病，是享受</span>    
                            </div>
                            
                        </a>
                        <span class="follow-bt">关注</span>
                    </li>
                    <li class="mui-table-view-cell">
                        <a class="mui-navigate">
                            <img src="../image/user/my_feedback.png" alt="">
                            <div class="topic-circle-info">
                                <span>最爱自拍</span><i class="member-ico fa fa-users"></i><span class="member-count">5423</span><br>
                                <span class="topic-circle-desc">爱自拍不是病，是享受</span>    
                            </div>
                            
                        </a>
                        <span class="follow-bt">关注</span>
                    </li> -->
                  <!--   <li class="mui-table-view-cell">
                        <a class="mui-navigate"><img src="../image/user/my_topic.png" alt=""><span>恋爱补习班</span></a>
                        <span class="pull-right follow-bt">关注</span>
                    </li>
                    <li class="mui-table-view-cell">
                        <a class="mui-navigate"><img src="../image/user/my_fav.png" alt=""><span>女生内衣的那些事儿</span></a>
                        <span class="pull-right follow-bt">关注</span>
                    </li>
                    <li class="mui-table-view-cell">
                        <a class="mui-navigate"><img src="../image/user/my_setting.png" alt=""><span>请叫我段子手</span></a>
                        <span class="pull-right follow-bt">关注</span>
                    </li>
                    <li class="mui-table-view-cell">
                        <a class="mui-navigate"><img src="../image/user/my_feedback.png" alt=""><span>有人在朋友圈刷屏了</span></a>
                        <span class="pull-right follow-bt">关注</span>
                    </li> -->
                    
                </ul>
                <div class="checkmore" onclick="openWin('topicAllCircle');">查看所有话题圈></div>
            </div>
            
        </div>
    </div>
</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src='../script/common.js'></script>
<script>
    $(function(){
        $('.no-follow').click(function(){
            api.openWin({        
                name:   'topicAllCircle',
                url:    'topicAllCircle.html',
                pageParam: {},
                reload: false,
                opaque: true,
                vScrollBarEnabled: false,
                softInputMode: 'resize'
            });
        });
        initDev();
    });

    function addMyFollowedCircle(){
    	api_ajax(2,
    			'my_favorite_circle_list.php',
    			{
					fid: 0,
					page:myFollowedCurrentPage
				},
				after_addMyFollowedCircle,
				0,
				0
			);  
	}
	
	function after_addMyFollowedCircle(ret, _, _, _) {		
        if(ret['code']==101){
            $('.no-follow').show();
        }else if(ret['code']==100){
            appendTopicCircle(ret.data.info.list,'#my-circle-list',true);
        }
    }

    function getMyFollowedCircle(){ 
    	api_ajax(1,
    			'my_favorite_circle_list.php',
    			{
                    page:1,
                    psize:7
                },
				after_getMyFollowedCircle,
				0,
				0
			);
	}
	
	function after_getMyFollowedCircle(ret, _, _, _) {		        
            if(ret['code']==101){
                $('#my-circle-list').empty();
                $('.no-follow').show();
                $('.checkmore-myfollowed').hide();
            }else if(ret['code']==100){
                $('.no-follow').hide();
                myFollowedCurrentPage = 1;
                console.log(ret);
                myFollowedTotoalPage = ret.data.info.pageinfo.totalpage;
                myFollowedTotalCount = ret.data.info.pageinfo.recordcount;
                // if(myFollowedTotalCount>=10){
                //     $('.possible-like-topic').hide();
                // }else{
                //     $('.possible-like-topic').show();
                // }
                if(myFollowedTotoalPage<=1){
                    //$('.checkmore-myfollowed').hide();
                    $('.checkmore-myfollowed').hide();
                }else{
                    $('.checkmore-myfollowed').show();
                }
                listTopicCircle(ret.data.info.list,'#my-circle-list',true);
            }
    }

    function getRecommendTopicCircle(){
    	api_ajax(0,
    			'topic_circle_list.php',
    			{
                    psize:10,
                    page:1,
                    t:2
                },
				after_getRecommendTopicCircle,
				0,
				0
			);
	}
	function after_getRecommendTopicCircle(ret, _, _, _) {			    
            console.log(ret);
            if(ret['code']==100){
                $('.possible-like-topic').show();
                var circlelist = ret.data.info.list;
                listTopicCircle(circlelist,'#circle-list',false);
            }else{
                $('.possible-like-topic').hide();
            }
			isFirst = 0;
    }

    function listTopicCircle(circleList,holderClass,isMy){
        var circleListHtml = '';
        for(var index in circleList){
            var circle = circleList[index];
            var followHtml = '<span class="follow-bt" id="circle-btn-'+circle.fid+'" data-fid="'+circle.fid+'" onclick="favoriteCircle('+circle.fid+',\'add\',event,this);">关注</span>';
            var isFollowed = false;
            if(isMy == 1){
                if(circle.is_new){
                    followHtml = '<span class="follow-bt weiguan-bt" id="circle-btn-'+circle.fid+'" data-fid="'+circle.fid+'" style="border:none;">NEW</span>';
                    
                }else{
                    followHtml = '<span class="follow-bt" id="circle-btn-'+circle.fid+'" data-fid="'+circle.fid+'" style="border:none;">' + circle.no_read + '</span>';
                }
                
                isFollowed =true;
            }
            var html = '<li class="mui-table-view-cell" id="circle-item-'+circle.fid+'" onclick="openCircle('+circle.fid+',\''+circle.fname+'\',event,this)">'+
                            '<a class="mui-navigate">'+
                                '<img class="" src="'+circle.icon+'" alt="">'+
                                '<div class="topic-circle-info">'+
                                    '<span>'+circle.fname+'</span><i class="member-ico fa fa-users"></i><span class="member-count">'+circle.fav_count+'</span><br>'+
                                    '<span class="topic-circle-desc">'+circle.description+'</span>'+    
                                '</div>'+
                            '</a>'+followHtml
                            +
                        '</li>';
           circleListHtml += html;
        }
        $(holderClass).empty();
        $(holderClass).append($(circleListHtml));
    }
    
    function appendTopicCircle(circleList,holderClass,isMy){
        var circleListHtml = '';
        for(var index in circleList){
            var circle = circleList[index];
            var followHtml = '<span class="follow-bt" id="circle-btn-'+circle.fid+'" data-fid="'+circle.fid+'" onclick="favoriteCircle('+circle.fid+',\'add\',event,this);">关注</span>';
            var isFollowed = false;
            if(isMy == 1){
                if(circle.is_new){
                    followHtml = '<span class="follow-bt weiguan-bt" id="circle-btn-'+circle.fid+'" data-fid="'+circle.fid+'" style="border:none;">NEW</span>';
                    
                }else{
                    followHtml = '<span class="follow-bt" id="circle-btn-'+circle.fid+'" data-fid="'+circle.fid+'" style="border:none;">' + circle.no_read + '</span>';
                }
                isFollowed =true;
            }
            // if(circle.fname.indexOf('不显示')>-1){
            //     circle.fname = '';
            // }
            var html = '<li class="mui-table-view-cell" id="circle-item-'+circle.fid+'" onclick="openCircle('+circle.fid+',\''+circle.fname+'\',event,this)">'+
                            '<a class="mui-navigate">'+
                                '<img class="" src="'+circle.icon+'" alt="">'+
                                '<div class="topic-circle-info">'+
                                    '<span>'+circle.fname+'</span><i class="member-ico fa fa-users"></i><span class="member-count">'+circle.fav_count+'</span><br>'+
                                    '<span class="topic-circle-desc">'+circle.description+'</span>'+    
                                '</div>'+
                            '</a>'+followHtml
                            +
                        '</li>';
            circleListHtml += html;
        }
        $(holderClass).append($(circleListHtml));
    }
 
    function openCircle(fid,fname,e,self){       
        if($(self).hasClass('weiguan')){
            $(self).children('.weiguan-bt').hide();
        }
        openTopicCircle(fid,fname,e);
    }
    
    function afterFavoriteCircle(act,dom){
        console.log(act);
        if(act == 'add'){
            //getTopicCircle();
            console.log($(dom).html());
            $('#my-circle-list').prepend($(dom).text('NEW').addClass('weiguan-bt').attr('onclick','javascript:;').parent().addClass('weiguan animated fadeInLeft').clone().fadeIn());

            $('.no-follow').hide();
            //$(dom).parent().slideUp(); 
            setTimeout(function(){
                $(dom).parent().remove();  
                if($('#circle-list>li').length<1){
                    $('.possible-like-topic').fadeOut();
                }
                
            },500);

            //$(dom).html('已关注').css({'border-color':'#aaa','color':'#999'});
        } else if(act == 'cancel') {
            $('#circle-list').prepend($(dom).text('关注').show().removeClass('weiguan-bt').css({'border':'1px solid #faa'}).attr('onclick','favoriteCircle('+$(dom).data('fid')+',\'add\',event,this);').parent().addClass('weiguan animated fadeInLeft').clone().fadeIn());
           
            setTimeout(function(){
                $(dom).parent().remove();
                
                if($('#my-circle-list').length<1){
                   $('.no-follow').show();
                }
                
            },500);
        }  
         $(dom).parent().addClass('animated fadeOutLeft');

    }
 
    function removeCircle(fid){
        $('#circle-item-'+fid).remove();
        alert('#circle-item-'+fid);
    }
    
    var uid = 0;
    var myFollowedCurrentPage = 1;
    var myFollowedTotoalPage = 0;
    var myFollowedTotalCount = 0;
    var isFirst = 1;
    var lastTime = 0;
    
    apiready = function(){
        //var header = $api.byId('header');
        //$api.fixIos7Bar(header);
        
        isDev = false;
        uid = $api.getStorage('uid');
        //alert(uid);
        lastTime = (new Date()).valueOf();
        api.setRefreshHeaderInfo({
            visible: true,
            // loadingImgae: 'wgt://image/refresh-white.png',
            bgColor: '#f2f2f2',
            textColor: '#4d4d4d',
            textDown: '下拉刷新...',
            textUp: '松开刷新...',
            showTime: false
        }, function (ret, err) {
            api.hideProgress();
	        var nowTime = (new Date()).valueOf();
	        if (nowTime-lastTime > 180000) {		//3*60*1000 = 180000
	        	lastTime = nowTime;       
            	getMyFollowedCircle();
            	getRecommendTopicCircle();           	
            }	          
            api.refreshHeaderLoadDone();
        });

        getMyFollowedCircle();
        getRecommendTopicCircle();
 	
	    api.addEventListener({
	      name:'viewappear'
	    },function(ret,err){
			//if (isFirst == 0)	
			{
			 	var fav_fid = $api.getStorage('fav_fid');	
				if (fav_fid) {
					//myToast("change: "+ fav_fid); 
					if (fav_fid > 0) {
						var dom = $('#circle-btn-'+fav_fid);
						afterFavoriteCircle('add', dom);
					} else {
						fav_fid = -1 * fav_fid;
						var dom = $('#circle-btn-'+fav_fid);
						afterFavoriteCircle('cancel', dom);					
					}
					$api.rmStorage('fav_fid');
				}
			}
	        api.execScript({
	            name: 'root',
	            script: 'checkCurPid("topic", "topicFollow")'
	        });				
       	});
       	
        api.addEventListener({
             name: 'scrolltobottom',
             extra:{
                 threshold:200    //设置距离底部多少距离时触发，默认值为0，数字类型
            }
         }, function (ret, err) {
            api.execScript({
                frameName:'topic',
                script:'hideExplore();'
            });
         });

        $('.checkmore-myfollowed').click(function(){
            if(myFollowedCurrentPage < myFollowedTotoalPage){
                myFollowedCurrentPage++;
                addMyFollowedCircle();
                if(myFollowedCurrentPage == myFollowedTotoalPage-1){
                    $(this).hide();    
                }
            }
            else{
                $(this).hide();
            }
        });

        api.addEventListener({
            name:'swiperight'
        },function(ret,err){
            //operation
            api.execScript({
                frameName:'topic',
                script:'showExplore();'
            });
        });
    }
  
function  view_appear(show) {
	console.log("view_appear(topicFollow)");
}
    
</script>
</html>